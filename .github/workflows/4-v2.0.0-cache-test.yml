name: 4- Docker Build and Push with Cache Testing

on:
  workflow_dispatch:
    inputs:
      cache_type:
        description: 'Cache type to test'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - gha-cache
          - registry-cache
          - no-cache
  push:
    paths:
      - '.github/workflows/4-v2.0.0-cache-test.yml'

jobs:
  # ==========================================
  # Build without Cache
  # ==========================================
  no-cache-build:
    if: github.event.inputs.cache_type == 'all' || github.event.inputs.cache_type == 'no-cache' || github.event.inputs.cache_type == ''
    runs-on: ubuntu-latest
    name: Build Without Cache
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: "üîß Build Without Cache"
        id: build_no_cache
        uses: dinushchathurya/build-tag-push-action@v2.0.0-rc.1
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
          context: .
          file: Dockerfile
          repoOwner: ${{ secrets.DOCKER_USERNAME }}
          repository: build-push-tag-action
          tag: no-cache-${{ github.run_number }}
          platforms: linux/amd64
          no_cache: true
          labels: |
            cache.strategy=none
            test.type=no-cache
  
  # ==========================================
  # Build with GitHub Actions Cache
  # ==========================================
  gha-cache-build:
    if: github.event.inputs.cache_type == 'all' || github.event.inputs.cache_type == 'gha-cache' || github.event.inputs.cache_type == ''
    runs-on: ubuntu-latest
    name: GitHub Actions Cache
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: "Build with GitHub Actions Cache"
        id: build_gha_cache
        uses: dinushchathurya/build-tag-push-action@v2.0.0-rc.1
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
          context: .
          file: Dockerfile
          repoOwner: ${{ secrets.DOCKER_USERNAME }}
          repository: build-push-tag-action
          tag: gha-cache-${{ github.run_number }}
          platforms: linux/amd64,linux/arm64
          cache_from: type=gha
          cache_to: type=gha,mode=max
          labels: |
            cache.strategy=github-actions
            cache.enabled=true
            test.type=gha-cache
  
  # ==========================================
  # Build with Registry Cache
  # ==========================================
  registry-cache-build:
    if: github.event.inputs.cache_type == 'all' || github.event.inputs.cache_type == 'registry-cache' || github.event.inputs.cache_type == ''
    runs-on: ubuntu-latest
    name: Registry Cache
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: "üè™ Build with Registry Cache"
        id: build_registry_cache
        uses: dinushchathurya/build-tag-push-action@v2.0.0-rc.1
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
          context: .
          file: Dockerfile
          repoOwner: ${{ secrets.DOCKER_USERNAME }}
          repository: build-push-tag-action
          tag: registry-cache-${{ github.run_number }}
          platforms: linux/amd64
          cache_from: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/build-push-tag-action:cache
          cache_to: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/build-push-tag-action:cache,mode=max
          labels: |
            cache.strategy=registry
            cache.enabled=true
            test.type=registry-cache
  
  # ==========================================
  # Combined Cache Build
  # ==========================================
  combined-cache-build:
    if: github.event.inputs.cache_type == 'all' || github.event.inputs.cache_type == ''
    runs-on: ubuntu-latest
    name: Combined Cache Sources
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: "Build with Combined Cache"
        id: build_combined_cache
        uses: dinushchathurya/build-tag-push-action@v2.0.0-rc.1
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
          context: .
          file: Dockerfile
          repoOwner: ${{ secrets.DOCKER_USERNAME }}
          repository: build-push-tag-action
          tag: combined-${{ github.run_number }}
          platforms: linux/amd64
          cache_from: |
            type=gha
            type=registry,ref=${{ secrets.DOCKER_USERNAME }}/build-push-tag-action:cache
          cache_to: |
            type=gha,mode=max
            type=registry,ref=${{ secrets.DOCKER_USERNAME }}/build-push-tag-action:cache,mode=max
          labels: |
            cache.strategy=combined
            cache.sources=gha,registry
            test.type=combined-cache