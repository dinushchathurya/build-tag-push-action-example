name: 06 - Security Features Test

on:
  workflow_dispatch:
  push:
    paths:
      - '.github/workflows/6-v2.0.0-security.yml'

jobs:
  security-attestations:
    runs-on: ubuntu-latest
    name: Security Attestations Test
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: "üîí Build with Security Features"
        id: security_build
        uses: dinushchathurya/build-tag-push-action@v2.0.0-rc.1
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
          context: .
          file: Dockerfile
          repoOwner: ${{ secrets.DOCKER_USERNAME }}
          repository: test-security
          tag: security-${{ github.run_number }}
          platforms: linux/amd64,linux/arm64
          
          # Security features
          provenance: true
          sbom: true
          
          # Cache for reproducible builds
          cache_from: type=gha
          cache_to: type=gha,mode=max
          
          # Security-focused labels
          labels: |
            org.opencontainers.image.title=Security Test Image
            org.opencontainers.image.description=Testing security attestations
            org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.created=${{ github.event.head_commit.timestamp }}
            org.opencontainers.image.vendor=Security Test
            org.opencontainers.image.licenses=MIT
            security.scan.enabled=true
            security.attestation.provenance=true
            security.attestation.sbom=true
            test.type=security-features

  secure-build-with-secrets:
    runs-on: ubuntu-latest
    name: Secure Build with Secrets
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Create Test Secrets
        run: |
          mkdir -p /tmp/secrets
          echo "test-api-key-12345" > /tmp/secrets/api_key
          echo "test-db-password" > /tmp/secrets/db_password
          chmod 600 /tmp/secrets/*
        
      - name: "üîê Build with Secrets"
        uses: dinushchathurya/build-tag-push-action@v2.0.0-rc.1
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
          context: .
          file: Dockerfile
          repoOwner: ${{ secrets.DOCKER_USERNAME }}
          repository: test-secrets
          tag: secrets-${{ github.run_number }}
          
          # Secrets for build
          secrets: |
            id=api_key,src=/tmp/secrets/api_key
            id=db_password,src=/tmp/secrets/db_password
          
          # Security attestations
          provenance: true
          sbom: true
          
          labels: |
            test.type=secure-build-with-secrets
            security.secrets=true
            org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}